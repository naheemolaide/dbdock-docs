# DBDock

Enterprise-grade PostgreSQL backup and restore. Beautiful CLI with real-time progress tracking.

[![npm version](https://img.shields.io/npm/v/dbdock.svg)](https://www.npmjs.com/package/dbdock)
[![License: MIT](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Node.js](https://img.shields.io/badge/node-%3E%3D18-brightgreen)](https://nodejs.org)
[![Documentation](https://img.shields.io/badge/docs-dbdock.mintlify.app-blue)](https://dbdock.mintlify.app)

ğŸ“š **[Full Documentation](https://dbdock.mintlify.app)** | ğŸ’¬ **[Discussions](https://github.com/naheemolaide/dbdock-support/discussions)** | ğŸ› **[Issues](https://github.com/naheemolaide/dbdock-support/issues)**

## Quick Start

```bash
npx dbdock init      # Interactive setup
npx dbdock backup    # Create backup
npx dbdock restore   # Restore backup
```

## Features

- **Beautiful CLI** - Real-time progress bars, speed tracking, smart filtering
- **Multiple Storage** - Local, AWS S3, Cloudflare R2, Cloudinary
- **Security** - AES-256 encryption, Brotli compression
- **Retention Policies** - Automatic cleanup by count/age with safety nets
- **Smart UX** - Intelligent filtering for 100+ backups, clear error messages
- **Email Alerts** - SMTP notifications with custom templates
- **TypeScript Native** - Full type safety for programmatic usage
- **Automation** - Cron schedules, auto-cleanup after backups

## Installation

**Global Installation (Recommended):**

```bash
npm install -g dbdock

dbdock init      # Use directly
dbdock backup
dbdock status
```

**Or use with npx (No installation needed):**

```bash
npx dbdock init
npx dbdock backup
npx dbdock status
```

## CLI Commands

### `dbdock init`

Interactive setup wizard that creates `dbdock.config.json` with:

- Database connection (host, port, credentials)
- Storage provider (Local, S3, R2, Cloudinary)
- Encryption/compression settings
- Email alerts (optional)

Auto-adds config to `.gitignore` to protect credentials.

### `npx dbdock backup`

Creates database backup with real-time progress tracking:

```
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ | 100% | 45.23/100 MB | Speed: 12.50 MB/s | ETA: 0s | Uploading to S3
âœ” Backup completed successfully
```

**Options:**

```bash
npx dbdock backup --encrypt --compress --compression-level 9
```

- `--encrypt` / `--no-encrypt` - Toggle encryption
- `--compress` / `--no-compress` - Toggle compression
- `--encryption-key <key>` - 64-char hex key (must be exactly 64 hexadecimal characters)
- `--compression-level <1-11>` - Compression level (default: 6)

**Generate encryption key:**

```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

**Backup Formats:**

- `custom` (default) - PostgreSQL custom binary format (.sql)
- `plain` - Plain SQL text format (.sql)
- `directory` - Directory format (.dir)
- `tar` - Tar archive format (.tar)

### `npx dbdock restore`

Interactive restore with smart filtering and multi-step progress:

```
Progress:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  âœ” Downloading backup
  âœ” Decrypting data
  âœ” Decompressing data
  âŸ³ Restoring to database...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ” All steps completed in 8.42s
```

**Smart filtering** (auto-enabled for 20+ backups):

- Show recent (last 10)
- Date range (24h, 7d, 30d, 90d, custom)
- Search by keyword/ID

Shows database stats and requires confirmation before restore.

### `npx dbdock list`

View backups with smart filtering:

```bash
npx dbdock list                  # All backups
npx dbdock list --recent 10      # Last 10
npx dbdock list --search keyword # Search
npx dbdock list --days 7         # Last 7 days
```

**Auto-filtering** for 50+ backups with interactive prompts.

### `npx dbdock delete`

Delete backups interactively or by key:

```bash
npx dbdock delete              # Interactive
npx dbdock delete --key <id>   # Specific backup
npx dbdock delete --all        # All (with confirmation)
```

### `npx dbdock cleanup`

Clean up old backups based on retention policy:

```bash
npx dbdock cleanup              # Interactive with preview
npx dbdock cleanup --dry-run    # Preview only
npx dbdock cleanup --force      # Skip confirmation
```

Shows detailed preview of what will be deleted and space to reclaim.

### `dbdock status`

Quick view of all schedules and service status:

```bash
dbdock status
```

**Output:**

```
ğŸ“… Scheduled Backups:

â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  #  â”‚ Name         â”‚ Cron Expression â”‚ Status   â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   1 â”‚ daily        â”‚ 0 * * * *       â”‚ âœ“ Active â”‚
â”‚   2 â”‚ weekly       â”‚ 0 0 * * 0       â”‚ âœ— Paused â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Total: 2 schedule(s) - 1 active, 1 paused

ğŸš€ Service Status:

ğŸŸ¢ Running (PM2)
  PID: 12345
  Uptime: 2d 5h
  Memory: 45.23 MB
```

### `dbdock test`

Validates database, storage, and email configuration.

### `dbdock schedule`

Manage backup schedules in configuration:

```bash
dbdock schedule
```

**Features:**

- View current schedules with status
- Add new schedule with cron expression presets
- Remove or toggle (enable/disable) schedules
- Saves to `dbdock.config.json`

**Schedule Presets:**

- Every hour: `0 * * * *`
- Every day at midnight: `0 0 * * *`
- Every day at 2 AM: `0 2 * * *`
- Every week (Sunday): `0 0 * * 0`
- Every month (1st): `0 0 1 * *`
- Custom cron expression

**âš ï¸ Important:** Schedules only execute when DBDock is integrated into your Node.js application (see Programmatic Usage below). The CLI is for configuration only.

## Configuration

After running `npx dbdock init`, a `dbdock.config.json` file is created:

```json
{
  "database": {
    "type": "postgres",
    "host": "localhost",
    "port": 5432,
    "username": "postgres",
    "password": "your-password",
    "database": "myapp"
  },
  "storage": {
    "provider": "s3",
    "s3": {
      "bucket": "my-backups",
      "region": "us-east-1",
      "accessKeyId": "YOUR_ACCESS_KEY",
      "secretAccessKey": "YOUR_SECRET_KEY"
    }
  },
  "backup": {
    "format": "custom",
    "compression": {
      "enabled": true,
      "level": 6
    },
    "encryption": {
      "enabled": true,
      "key": "64-character-hex-key-generated-with-openssl-or-node-crypto"
    },
    "retention": {
      "enabled": true,
      "maxBackups": 100,
      "maxAgeDays": 30,
      "minBackups": 5,
      "runAfterBackup": true
    }
  },
  "alerts": {
    "email": {
      "enabled": true,
      "smtp": {
        "host": "smtp.gmail.com",
        "port": 587,
        "secure": false,
        "auth": {
          "user": "your-email@gmail.com",
          "pass": "your-app-password"
        }
      },
      "from": "backups@yourapp.com",
      "to": ["admin@yourapp.com"]
    }
  }
}
```

### Storage Providers

**Local:**

```json
{ "storage": { "provider": "local", "local": { "path": "./backups" } } }
```

**AWS S3:**

```json
{
  "storage": {
    "provider": "s3",
    "s3": {
      "bucket": "my-backups",
      "region": "us-east-1",
      "accessKeyId": "YOUR_KEY",
      "secretAccessKey": "YOUR_SECRET"
    }
  }
}
```

Required permissions: `s3:PutObject`, `s3:GetObject`, `s3:ListBucket`, `s3:DeleteObject`

**Cloudflare R2:**

```json
{
  "storage": {
    "provider": "r2",
    "s3": {
      "bucket": "my-backups",
      "region": "auto",
      "endpoint": "https://ACCOUNT_ID.r2.cloudflarestorage.com",
      "accessKeyId": "YOUR_KEY",
      "secretAccessKey": "YOUR_SECRET"
    }
  }
}
```

**Cloudinary:**

```json
{
  "storage": {
    "provider": "cloudinary",
    "cloudinary": {
      "cloudName": "your-cloud",
      "apiKey": "YOUR_KEY",
      "apiSecret": "YOUR_SECRET"
    }
  }
}
```

All cloud backups stored in `dbdock_backups/` folder with format: `backup-YYYY-MM-DD-HH-MM-SS-BACKUPID.sql`

### Retention Policy

Automatic cleanup to prevent storage bloat from frequent backups:

```json
{
  "backup": {
    "retention": {
      "enabled": true,
      "maxBackups": 100,
      "maxAgeDays": 30,
      "minBackups": 5,
      "runAfterBackup": true
    }
  }
}
```

**How it works:**

- Keeps most recent `minBackups` (safety net, never deleted)
- Deletes backups exceeding `maxBackups` limit (oldest first)
- Deletes backups older than `maxAgeDays` (respecting minBackups)
- Runs automatically after each backup (if `runAfterBackup: true`)
- Manual cleanup: `npx dbdock cleanup`

**Safety features:**

- Always preserves `minBackups` most recent backups
- Shows preview before deletion
- Detailed logging of what was deleted
- Error handling for failed deletions

## Programmatic Usage

Use DBDock in your Node.js application to create backups programmatically. You don't need to understand NestJS internals - DBDock provides a simple API that works with any Node.js backend.

### Basic Setup

First, install DBDock:

```bash
npm install dbdock
```

Make sure you have `dbdock.config.json` configured (run `npx dbdock init` first). DBDock reads all configuration from this file automatically.

### How It Works

DBDock uses a simple initialization pattern:

1. Call `createDBDock()` to initialize DBDock (reads from `dbdock.config.json`)
2. Get the `BackupService` from the returned context using `.get(BackupService)`
3. Use the service methods to create backups, list backups, etc.

Think of `createDBDock()` as a factory function that sets up everything for you based on your config file.

### Creating Backups

```javascript
const { createDBDock, BackupService } = require('dbdock');

async function createBackup() {
  const dbdock = await createDBDock();
  const backupService = dbdock.get(BackupService);

  const result = await backupService.createBackup({
    compress: true,
    encrypt: true,
  });

  console.log(`Backup created: ${result.metadata.id}`);
  console.log(`Size: ${result.metadata.size} bytes`);
  return result;
}

createBackup().catch(console.error);
```

**Backup Options:**

- `compress` - Enable/disable compression (default: from config)
- `encrypt` - Enable/disable encryption (default: from config)
- `type` - Backup type: `'full'` (default), `'schema'`, `'data'`

### Listing Backups

```javascript
const { createDBDock, BackupService } = require('dbdock');

async function listBackups() {
  const dbdock = await createDBDock();
  const backupService = dbdock.get(BackupService);

  const backups = await backupService.listBackups();
  
  console.log(`Found ${backups.length} backups:`);
  backups.forEach(backup => {
    console.log(`- ${backup.id} (${backup.size} bytes, created: ${backup.startTime})`);
  });
  
  return backups;
}

listBackups().catch(console.error);
```

### Getting Backup Metadata

```javascript
const { createDBDock, BackupService } = require('dbdock');

async function getBackupInfo(backupId) {
  const dbdock = await createDBDock();
  const backupService = dbdock.get(BackupService);

  const metadata = await backupService.getBackupMetadata(backupId);
  
  if (!metadata) {
    console.log('Backup not found');
    return null;
  }
  
  console.log('Backup details:', {
    id: metadata.id,
    size: metadata.size,
    created: metadata.startTime,
    encrypted: !!metadata.encryption,
    compressed: metadata.compression.enabled,
  });
  
  return metadata;
}

getBackupInfo('your-backup-id').catch(console.error);
```

**Note:** Restore functionality is currently only available via CLI (`npx dbdock restore`). Programmatic restore will be available in a future release.

### Express.js Integration

Here's a complete Express.js example with backup endpoints:

```bash
npm install dbdock express
```

```javascript
const express = require('express');
const { createDBDock, BackupService } = require('dbdock');

const app = express();
app.use(express.json());

let backupService = null;

async function initializeDBDock() {
  const dbdock = await createDBDock();
  backupService = dbdock.get(BackupService);
  console.log('DBDock initialized successfully');
}

app.post('/api/backup', async (req, res) => {
  try {
    if (!backupService) {
      return res.status(503).json({ 
        success: false, 
        error: 'DBDock not initialized' 
      });
    }

    const result = await backupService.createBackup({
      compress: req.body.compress !== false,
      encrypt: req.body.encrypt !== false,
    });

    res.json({
      success: true,
      backupId: result.metadata.id,
      size: result.metadata.size,
      message: 'Backup created successfully',
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});

app.get('/api/backups', async (req, res) => {
  try {
    if (!backupService) {
      return res.status(503).json({ 
        success: false, 
        error: 'DBDock not initialized' 
      });
    }

    const backups = await backupService.listBackups();
    res.json({ success: true, backups });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});

app.get('/api/backups/:backupId', async (req, res) => {
  try {
    if (!backupService) {
      return res.status(503).json({ 
        success: false, 
        error: 'DBDock not initialized' 
      });
    }

    const metadata = await backupService.getBackupMetadata(req.params.backupId);
    
    if (!metadata) {
      return res.status(404).json({
        success: false,
        error: 'Backup not found',
      });
    }

    res.json({ success: true, backup: metadata });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});

const PORT = process.env.PORT || 3000;

initializeDBDock()
  .then(() => {
    app.listen(PORT, () => {
      console.log(`Server running on port ${PORT}`);
    });
  })
  .catch((error) => {
    console.error('Failed to initialize DBDock:', error);
    process.exit(1);
  });
```

### Schedule Management

DBDock stores schedules in `dbdock.config.json` - the same file used by the CLI. This means schedules created via CLI or code are always in sync.

**Managing Schedules:**

```javascript
const { ScheduleManager } = require('dbdock');

const scheduleManager = new ScheduleManager();

scheduleManager.addSchedule({
  name: 'Hourly Backup',
  cron: '0 * * * *',
  enabled: true,
});

const schedules = scheduleManager.getSchedules();
console.log('All schedules:', schedules);

scheduleManager.updateSchedule('Hourly Backup', {
  cron: '0 */2 * * *',
});

scheduleManager.enableSchedule('Daily Backup');
scheduleManager.disableSchedule('Weekly Full');

scheduleManager.removeSchedule('Old Schedule');
```

**ScheduleManager Methods:**

- `getSchedules()` - Get all schedules
- `addSchedule(schedule)` - Add a new schedule
- `updateSchedule(name, updates)` - Update an existing schedule
- `removeSchedule(name)` - Remove a schedule
- `enableSchedule(name)` - Enable a schedule
- `disableSchedule(name)` - Disable a schedule
- `getSchedule(name)` - Get a specific schedule

**Custom Config Path:**

```javascript
const scheduleManager = new ScheduleManager('/path/to/custom-config.json');
```

### Scheduled Backups with Express

Set up automatic backups using `node-cron`:

```bash
npm install dbdock express node-cron
```

```javascript
const express = require('express');
const cron = require('node-cron');
const { createDBDock, BackupService, ScheduleManager } = require('dbdock');

const app = express();
app.use(express.json());

let backupService = null;

async function initializeDBDock() {
  const dbdock = await createDBDock();
  backupService = dbdock.get(BackupService);
  console.log('DBDock initialized successfully');
}

function setupScheduledBackups() {
  const scheduleManager = new ScheduleManager();
  const schedules = scheduleManager.getSchedules();

  schedules.forEach((schedule) => {
    if (schedule.enabled) {
      cron.schedule(schedule.cron, async () => {
        try {
          console.log(`Running scheduled backup: ${schedule.name}`);
          const result = await backupService.createBackup({
            compress: true,
            encrypt: true,
          });
          console.log(`Scheduled backup completed: ${result.metadata.id}`);
        } catch (error) {
          console.error(`Scheduled backup failed: ${error.message}`);
        }
      });
      console.log(`Scheduled backup "${schedule.name}" registered`);
    }
  });
}

app.post('/api/backup', async (req, res) => {
  try {
    if (!backupService) {
      return res.status(503).json({ error: 'DBDock not initialized' });
    }
    const result = await backupService.createBackup({
      compress: true,
      encrypt: true,
    });
    res.json({
      success: true,
      backupId: result.metadata.id,
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

const PORT = process.env.PORT || 3000;

initializeDBDock()
  .then(() => {
    setupScheduledBackups();
    app.listen(PORT, () => {
      console.log(`Server running on port ${PORT} with scheduled backups`);
    });
  })
  .catch((error) => {
    console.error('Failed to initialize DBDock:', error);
    process.exit(1);
  });
```

**How It Works:**

1. `ScheduleManager` reads schedules from `dbdock.config.json` (same file used by CLI)
2. Your Express app sets up cron jobs based on those schedules
3. When schedules change (via CLI or code), restart your app to pick up changes
4. All schedule management writes directly to `dbdock.config.json`

**Important:** Schedules only execute when your Node.js application is running. The CLI `dbdock schedule` command only manages the configuration - your application code runs the actual backups.

## Requirements

- Node.js 18 or higher
- PostgreSQL 12+
- PostgreSQL client tools (`pg_dump`, `pg_restore`, `psql`)

**Installing PostgreSQL client tools:**

```bash
# macOS
brew install postgresql

# Ubuntu/Debian
sudo apt-get install postgresql-client

# Windows
# Download from https://www.postgresql.org/download/windows/
```

## Troubleshooting

Run `npx dbdock test` to verify your configuration.

### Common Issues

**pg_dump not found:**

```bash
# macOS
brew install postgresql

# Ubuntu/Debian
sudo apt-get install postgresql-client
```

**Database connection errors:**

- Verify `host`, `port`, `username`, `password`, `database` in config
- Test connection: `psql -h HOST -p PORT -U USERNAME -d DATABASE`
- Check PostgreSQL server is running
- Verify network/firewall allows connection

**Storage errors:**

_AWS S3:_

- Verify credentials are correct
- Ensure IAM user has permissions: `s3:PutObject`, `s3:GetObject`, `s3:ListBucket`, `s3:DeleteObject`
- Check bucket name and region

_Cloudflare R2:_

- Verify API token is correct
- Check endpoint URL format: `https://ACCOUNT_ID.r2.cloudflarestorage.com`
- Ensure bucket exists and is accessible
- Verify R2 credentials have read/write permissions

_Cloudinary:_

- Verify cloud name, API key, and secret are correct
- Check your Cloudinary account is active
- Ensure API credentials have media library access

**Encryption key errors:**

```bash
# Generate a valid 64-character hex key
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# Must be exactly 64 hexadecimal characters (0-9, a-f, A-F)
```

**R2 restore not working:**

- Ensure backups are in `dbdock_backups/` folder
- Verify backup files are named with `.sql` extension
- Check endpoint configuration matches R2 account ID

**No backups found:**

- Local: Check files exist in configured path
- S3/R2: Verify files are in `dbdock_backups/` folder
- Cloudinary: Check Media Library for `dbdock_backups` folder
- Ensure files match pattern: `backup-*.sql`

DBDock shows clear, actionable error messages for all issues with specific troubleshooting steps.

## Documentation

ğŸ“š **[Full Documentation](https://dbdock.mintlify.app)** - Comprehensive guides, API reference, and examples

## Support

- ğŸ’¬ **[Discussions](https://github.com/naheemolaide/dbdock-support/discussions)** - Ask questions and share ideas
- ğŸ› **[Issues](https://github.com/naheemolaide/dbdock-support/issues)** - Report bugs and request features

## Links

- ğŸ“¦ **[npm Package](https://www.npmjs.com/package/dbdock)**
- ğŸ“– **[Documentation](https://dbdock.mintlify.app)**
- ğŸ’» **[GitHub Repository](https://github.com/naheemolaide/dbdock-support)**

## License

MIT
